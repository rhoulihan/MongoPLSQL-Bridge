{
  "description": "Complex aggregation pipelines for cross-database validation testing with deeply nested documents",
  "version": "1.0.0",
  "pipelines": [
    {
      "id": "PIPE001",
      "name": "E-commerce Order Revenue Analysis",
      "description": "Order-level revenue analysis by status and time period (without array unwinding)",
      "collection": "ecommerce_orders",
      "pipeline": [
        {
          "$match": {
            "status": { "$in": ["delivered", "shipped"] }
          }
        },
        {
          "$group": {
            "_id": {
              "status": "$status",
              "month": { "$month": "$timestamps.createdAt" },
              "year": { "$year": "$timestamps.createdAt" }
            },
            "totalRevenue": { "$sum": "$pricing.subtotal" },
            "orderCount": { "$sum": 1 },
            "avgShipping": { "$avg": "$pricing.shipping" },
            "avgTax": { "$avg": "$pricing.tax" }
          }
        },
        {
          "$addFields": {
            "avgRevenuePerOrder": {
              "$round": [{ "$divide": ["$totalRevenue", "$orderCount"] }, 2]
            }
          }
        },
        { "$sort": { "totalRevenue": -1 } },
        { "$limit": 50 }
      ]
    },
    {
      "id": "PIPE002",
      "name": "Product Performance Analysis",
      "description": "Analyze all products by category and brand with rating metrics (without array unwinding)",
      "collection": "ecommerce_products",
      "pipeline": [
        {
          "$group": {
            "_id": {
              "category": "$category.primary",
              "brand": "$brand.name"
            },
            "productCount": { "$sum": 1 },
            "avgRating": { "$avg": "$ratings.average" },
            "totalReviews": { "$sum": "$ratings.count" },
            "avgPrice": { "$avg": "$pricing.basePrice" },
            "minPrice": { "$min": "$pricing.basePrice" },
            "maxPrice": { "$max": "$pricing.basePrice" }
          }
        },
        {
          "$addFields": {
            "priceRange": {
              "$round": [{ "$subtract": ["$maxPrice", "$minPrice"] }, 2]
            }
          }
        },
        { "$sort": { "totalReviews": -1 } },
        { "$limit": 30 }
      ]
    },
    {
      "id": "PIPE003",
      "name": "Customer Lifetime Value Analysis",
      "description": "Calculate customer value with loyalty tier analysis and purchase patterns",
      "collection": "ecommerce_customers",
      "pipeline": [
        {
          "$match": {
            "metadata.status": "active",
            "orderHistory.totalOrders": { "$gte": 1 }
          }
        },
        {
          "$group": {
            "_id": "$loyalty.tier",
            "customerCount": { "$sum": 1 },
            "avgTotalSpent": { "$avg": "$orderHistory.totalSpent" },
            "avgTotalOrders": { "$avg": "$orderHistory.totalOrders" },
            "avgOrderValue": { "$avg": "$orderHistory.averageOrderValue" },
            "avgReturnRate": { "$avg": "$orderHistory.returnRate" }
          }
        },
        {
          "$addFields": {
            "avgReturnRatePercent": {
              "$round": [{ "$multiply": ["$avgReturnRate", 100] }, 1]
            }
          }
        },
        { "$sort": { "avgTotalSpent": -1 } }
      ]
    },
    {
      "id": "PIPE004",
      "name": "Review Sentiment and Quality Analysis",
      "description": "Analyze review quality with aspect ratings and helpfulness metrics",
      "collection": "ecommerce_reviews",
      "pipeline": [
        {
          "$match": {
            "metadata.status": "published",
            "verified": true
          }
        },
        {
          "$group": {
            "_id": {
              "sentiment": "$metadata.sentiment"
            },
            "reviewCount": { "$sum": 1 },
            "avgOverallRating": { "$avg": "$rating.overall" },
            "avgQualityRating": { "$avg": "$rating.aspects.quality" },
            "avgValueRating": { "$avg": "$rating.aspects.value" },
            "avgShippingRating": { "$avg": "$rating.aspects.shipping" },
            "avgPackagingRating": { "$avg": "$rating.aspects.packaging" },
            "totalUpvotes": { "$sum": "$helpful.upvotes" },
            "totalDownvotes": { "$sum": "$helpful.downvotes" }
          }
        },
        {
          "$addFields": {
            "helpfulnessRatio": {
              "$round": [
                { "$cond": [
                  { "$gt": [{ "$add": ["$totalUpvotes", "$totalDownvotes"] }, 0] },
                  { "$divide": ["$totalUpvotes", { "$add": ["$totalUpvotes", "$totalDownvotes"] }] },
                  0
                ] },
                2
              ]
            }
          }
        },
        { "$sort": { "reviewCount": -1 } },
        { "$limit": 40 }
      ]
    },
    {
      "id": "PIPE005",
      "name": "Analytics Session Funnel Analysis",
      "description": "Analyze conversion funnel with device and traffic source breakdown",
      "collection": "analytics_sessions",
      "pipeline": [
        {
          "$match": {
            "duration": { "$gte": 10 }
          }
        },
        {
          "$group": {
            "_id": {
              "deviceType": "$device.type",
              "trafficSource": "$traffic.source"
            },
            "sessionCount": { "$sum": 1 },
            "avgPageViews": { "$avg": "$engagement.pageViews" },
            "avgUniquePages": { "$avg": "$engagement.uniquePages" },
            "avgEvents": { "$avg": "$engagement.events" },
            "avgScrollDepth": { "$avg": "$engagement.scrollDepth" },
            "avgDuration": { "$avg": "$duration" },
            "conversions": { "$sum": { "$cond": ["$conversion.converted", 1, 0] } },
            "totalRevenue": { "$sum": "$conversion.revenue" },
            "totalTransactions": { "$sum": "$conversion.transactions" },
            "bounceCount": { "$sum": { "$cond": ["$bounced", 1, 0] } },
            "newUserCount": { "$sum": { "$cond": ["$isNewUser", 1, 0] } }
          }
        },
        {
          "$addFields": {
            "conversionRate": {
              "$round": [{ "$multiply": [{ "$divide": ["$conversions", "$sessionCount"] }, 100] }, 2]
            },
            "bounceRate": {
              "$round": [{ "$multiply": [{ "$divide": ["$bounceCount", "$sessionCount"] }, 100] }, 2]
            },
            "newUserRate": {
              "$round": [{ "$multiply": [{ "$divide": ["$newUserCount", "$sessionCount"] }, 100] }, 2]
            },
            "avgRevenuePerSession": {
              "$round": [{ "$divide": ["$totalRevenue", "$sessionCount"] }, 2]
            }
          }
        },
        { "$sort": { "conversionRate": -1, "sessionCount": -1 } },
        { "$limit": 30 }
      ]
    },
    {
      "id": "PIPE006",
      "name": "Social Post Engagement Analysis",
      "description": "Analyze post engagement including reaction and comment metrics",
      "collection": "social_posts",
      "pipeline": [
        {
          "$match": {
            "metadata.status": "published",
            "visibility": { "$in": ["public", "followers"] }
          }
        },
        {
          "$group": {
            "_id": {
              "postType": "$type"
            },
            "postCount": { "$sum": 1 },
            "avgLikes": { "$avg": "$reactions.like" },
            "avgLoves": { "$avg": "$reactions.love" },
            "avgLaughs": { "$avg": "$reactions.laugh" },
            "avgWows": { "$avg": "$reactions.wow" },
            "avgViews": { "$avg": "$engagement.views" },
            "avgReach": { "$avg": "$engagement.reach" },
            "avgImpressions": { "$avg": "$engagement.impressions" },
            "avgSaves": { "$avg": "$engagement.saves" },
            "totalShares": { "$sum": "$shares.count" },
            "sponsoredCount": { "$sum": { "$cond": ["$metadata.sponsored", 1, 0] } }
          }
        },
        {
          "$addFields": {
            "avgTotalReactions": {
              "$round": [{ "$add": [
                { "$ifNull": ["$avgLikes", 0] },
                { "$ifNull": ["$avgLoves", 0] },
                { "$ifNull": ["$avgLaughs", 0] },
                { "$ifNull": ["$avgWows", 0] }
              ] }, 0]
            },
            "sponsoredPercentage": {
              "$round": [{ "$multiply": [{ "$divide": ["$sponsoredCount", "$postCount"] }, 100] }, 1]
            }
          }
        },
        { "$sort": { "avgViews": -1 } }
      ]
    },
    {
      "id": "PIPE007",
      "name": "IoT Device Health Analysis by Building",
      "description": "Analyze device health status by building (without array unwinding)",
      "collection": "iot_devices",
      "pipeline": [
        {
          "$group": {
            "_id": {
              "building": "$location.building",
              "floor": "$location.floor"
            },
            "deviceCount": { "$sum": 1 },
            "onlineCount": { "$sum": { "$cond": ["$status.online", 1, 0] } },
            "healthyCount": { "$sum": { "$cond": [{ "$eq": ["$status.health", "healthy"] }, 1, 0] } },
            "avgBattery": { "$avg": "$status.battery" },
            "avgSignalStrength": { "$avg": "$status.signalStrength" },
            "avgSamplingRate": { "$avg": "$configuration.samplingRate" }
          }
        },
        {
          "$addFields": {
            "onlinePercentage": {
              "$round": [{ "$multiply": [{ "$divide": ["$onlineCount", "$deviceCount"] }, 100] }, 1]
            },
            "healthyPercentage": {
              "$round": [{ "$multiply": [{ "$divide": ["$healthyCount", "$deviceCount"] }, 100] }, 1]
            }
          }
        },
        { "$sort": { "healthyPercentage": 1, "deviceCount": -1 } },
        { "$limit": 40 }
      ]
    },
    {
      "id": "PIPE008",
      "name": "IoT Time-Series Aggregation",
      "description": "Aggregate sensor readings by hour (single group stage)",
      "collection": "iot_readings",
      "pipeline": [
        {
          "$group": {
            "_id": {
              "hourOfDay": { "$hour": "$timestamp" }
            },
            "readingCount": { "$sum": 1 },
            "avgTemperature": { "$avg": "$readings.temperature.value" },
            "minTemperature": { "$min": "$readings.temperature.value" },
            "maxTemperature": { "$max": "$readings.temperature.value" },
            "avgHumidity": { "$avg": "$readings.humidity.value" },
            "avgPressure": { "$avg": "$readings.pressure.value" },
            "goodTempReadings": {
              "$sum": { "$cond": [{ "$eq": ["$readings.temperature.quality", "good"] }, 1, 0] }
            },
            "avgTransmissionDelay": { "$avg": "$metadata.transmissionDelay" }
          }
        },
        {
          "$addFields": {
            "temperatureRange": { "$subtract": ["$maxTemperature", "$minTemperature"] },
            "dataQualityRate": {
              "$round": [
                { "$multiply": [{ "$divide": ["$goodTempReadings", "$readingCount"] }, 100] },
                1
              ]
            }
          }
        },
        { "$sort": { "readingCount": -1 } },
        { "$limit": 24 }
      ]
    },
    {
      "id": "PIPE009",
      "name": "User Follower Network Analysis",
      "description": "Analyze social user networks with engagement and activity patterns using bucket aggregation",
      "collection": "social_users",
      "pipeline": [
        {
          "$match": {
            "metadata.status": "active"
          }
        },
        {
          "$bucket": {
            "groupBy": "$stats.followers",
            "boundaries": [0, 100, 1000, 10000, 100000, 1000000, 10000000],
            "default": 10000001,
            "output": {
              "userCount": { "$sum": 1 },
              "verifiedCount": { "$sum": { "$cond": ["$profile.verified", 1, 0] } },
              "privateCount": { "$sum": { "$cond": ["$profile.private", 1, 0] } },
              "avgFollowing": { "$avg": "$stats.following" },
              "avgPosts": { "$avg": "$stats.posts" },
              "avgLikes": { "$avg": "$stats.likes" },
              "avgComments": { "$avg": "$stats.comments" },
              "avgShares": { "$avg": "$stats.shares" },
              "avgLoginStreak": { "$avg": "$activity.loginStreak" },
              "avgTimeSpent": { "$avg": "$activity.totalTimeSpent" }
            }
          }
        },
        {
          "$addFields": {
            "verifiedPercentage": {
              "$round": [{ "$multiply": [{ "$divide": ["$verifiedCount", "$userCount"] }, 100] }, 1]
            },
            "privatePercentage": {
              "$round": [{ "$multiply": [{ "$divide": ["$privateCount", "$userCount"] }, 100] }, 1]
            },
            "avgEngagement": {
              "$round": [{ "$add": ["$avgLikes", "$avgComments", "$avgShares"] }, 0]
            }
          }
        }
      ]
    },
    {
      "id": "PIPE010",
      "name": "Order Analysis by Payment and Shipping Method",
      "description": "Analyze all orders by payment method with totals metrics (without array unwinding)",
      "collection": "ecommerce_orders",
      "pipeline": [
        {
          "$group": {
            "_id": {
              "paymentMethod": "$payment.method",
              "shippingMethod": "$shipping.method"
            },
            "orderCount": { "$sum": 1 },
            "totalRevenue": { "$sum": "$pricing.subtotal" },
            "totalShipping": { "$sum": "$pricing.shipping" },
            "totalTax": { "$sum": "$pricing.tax" },
            "avgOrderValue": { "$avg": "$pricing.subtotal" },
            "maxOrderValue": { "$max": "$pricing.subtotal" },
            "minOrderValue": { "$min": "$pricing.subtotal" }
          }
        },
        {
          "$addFields": {
            "avgRevenuePerOrder": {
              "$round": [{ "$divide": ["$totalRevenue", "$orderCount"] }, 2]
            },
            "shippingPercent": {
              "$round": [
                { "$cond": [
                  { "$gt": ["$totalRevenue", 0] },
                  { "$multiply": [{ "$divide": ["$totalShipping", "$totalRevenue"] }, 100] },
                  0
                ] },
                1
              ]
            }
          }
        },
        { "$sort": { "totalRevenue": -1 } },
        { "$limit": 50 }
      ]
    }
  ]
}
